name: ðŸš€ Dev â†’ Prod Deployment

on:
  # Manual trigger only - you control when to deploy to production
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release'
        required: true
        default: 'minor'
        type: choice
        options:
        - patch
        - minor
        - major
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
        default: 'Latest features and improvements'
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

env:
  PROD_REPO: sebastienlepoder/cocktail-machine-prod
  DEV_REPO: sebastienlepoder/cocktail-machine-dev

jobs:
  dev-to-prod-deployment:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Dev Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.DEPLOY_TOKEN }}
        
    - name: ðŸ” Generate Release Version
      id: version
      run: |
        # Get current date for version
        DATE=$(date +%Y.%m.%d)
        TIME=$(date +%H%M)
        COMMIT_HASH=$(git rev-parse --short HEAD)
        
        # Determine version based on release type
        case "${{ github.event.inputs.release_type }}" in
          "major") VERSION="v${DATE}-major-${COMMIT_HASH}" ;;
          "minor") VERSION="v${DATE}-${TIME}-${COMMIT_HASH}" ;;
          "patch") VERSION="v${DATE}-patch-${COMMIT_HASH}" ;;
        esac
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Generated production version: $VERSION"
        
    - name: ðŸ—ï¸ Setup Node.js (if needed)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
      continue-on-error: true
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        if [ -d web ] && [ -f web/package.json ]; then
          cd web
          echo "ðŸ“¥ Installing dependencies..."
          npm ci || npm install || echo "âš ï¸ Failed to install dependencies"
        else
          echo "â„¹ï¸ No web project found, skipping dependencies"
        fi
      continue-on-error: true
        
    - name: ðŸ”¨ Build Dashboard
      run: |
        if [ -d web ] && [ -f web/package.json ]; then
          cd web
          echo "ðŸ”¨ Building dashboard..."
          npm run build || npm run export || echo "âš ï¸ No build script found"
        else
          echo "â„¹ï¸ No web project found, skipping build"
        fi
      continue-on-error: true
        
    - name: ðŸ“¦ Create Production Package (Mirror Dev Repo)
      run: |
        echo "ðŸ“¦ Creating production deployment package (exact copy of dev repo)..."
        
        # Create production directory - exact mirror of dev
        mkdir -p prod-deploy
        
        # Copy entire repository structure as-is
        echo "ðŸ’· Copying entire dev repository structure..."
        
        # Copy all directories and files, preserving structure
        [ -d web ] && cp -r web prod-deploy/ || echo "âš ï¸ No web directory"
        [ -d node-red ] && cp -r node-red prod-deploy/ || echo "âš ï¸ No node-red directory"
        [ -d scripts ] && cp -r scripts prod-deploy/ || echo "âš ï¸ No scripts directory"
        [ -d deployment ] && cp -r deployment prod-deploy/ || echo "âš ï¸ No deployment directory"
        [ -d kiosk ] && cp -r kiosk prod-deploy/ || echo "âš ï¸ No kiosk directory"
        [ -d esp32 ] && cp -r esp32 prod-deploy/ || echo "âš ï¸ No esp32 directory"
        [ -d data ] && cp -r data prod-deploy/ || echo "âš ï¸ No data directory"
        [ -d docs ] && cp -r docs prod-deploy/ || echo "âš ï¸ No docs directory"
        [ -d config ] && cp -r config prod-deploy/ || echo "âš ï¸ No config directory"
        [ -d src ] && cp -r src prod-deploy/ || echo "âš ï¸ No src directory"
        [ -d tests ] && cp -r tests prod-deploy/ || echo "âš ï¸ No tests directory"
        
        # Copy root files
        cp *.md prod-deploy/ 2>/dev/null || echo "âš ï¸ No markdown files to copy"
        cp *.yml prod-deploy/ 2>/dev/null || echo "âš ï¸ No yaml files to copy"
        cp *.json prod-deploy/ 2>/dev/null || echo "âš ï¸ No json files to copy"
        cp *.txt prod-deploy/ 2>/dev/null || echo "âš ï¸ No text files to copy"
        cp *.sh prod-deploy/ 2>/dev/null || echo "âš ï¸ No shell scripts in root to copy"
        cp .gitignore prod-deploy/ 2>/dev/null || echo "âš ï¸ No .gitignore to copy"
        
        # Make all scripts executable
        find prod-deploy -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
        
        # Add version info
        echo "${{ steps.version.outputs.version }}" > prod-deploy/VERSION
        
        # Create versions.json for update system
        cat > prod-deploy/versions.json << EOF
        {
          "latest": "${{ steps.version.outputs.version }}",
          "release_type": "${{ github.event.inputs.release_type }}",
          "release_notes": "${{ github.event.inputs.release_notes }}",
          "timestamp": "${{ steps.version.outputs.timestamp }}",
          "dev_repo": "${{ env.DEV_REPO }}",
          "dev_commit": "$(git rev-parse HEAD)",
          "dev_commit_short": "$(git rev-parse --short HEAD)"
        }
        EOF
        
        cd prod-deploy
        ls -la
        echo "âœ… Production package created (exact mirror of dev repository)!"
        
    - name: ðŸ“¤ Checkout Production Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.PROD_REPO }}
        token: ${{ secrets.DEPLOY_TOKEN }}
        path: prod-repo
        ref: main
        
    - name: ðŸš€ Deploy to Production
      run: |
        cd prod-repo
        
        echo "ðŸ”§ Configuring git for deployment..."
        git config user.name "Devâ†’Prod Deployment"
        git config user.email "actions@github.com"
        
        echo "ðŸ§¹ Cleaning old production files..."
        # Keep README but remove old deployments
        find . -mindepth 1 -maxdepth 1 ! -name 'README.md' ! -name '.git' -exec rm -rf {} + || true
        
        echo "ðŸ“‹ Copying new production files..."
        cp -r ../prod-deploy/* .
        
        echo "ðŸ“ Adding deployment info to README..."
        cat > README.md << 'EOF'
        # ðŸ¹ Cocktail Machine - Production Release
        
        **Latest Version:** `${{ steps.version.outputs.version }}`  
        **Release Type:** ${{ github.event.inputs.release_type }}  
        **Released:** ${{ steps.version.outputs.timestamp }}  
        **From Dev Repo:** [${{ env.DEV_REPO }}](https://github.com/${{ env.DEV_REPO }})
        
        ## ðŸš€ For Pi Users
        
        ### Quick Installation
        ```bash
        curl -fsSL https://raw.githubusercontent.com/${{ env.PROD_REPO }}/main/scripts/setup-ultimate.sh | bash
        ```
        
        ### Update Your System
        ```bash
        # Via Node-RED Dashboard (Recommended)
        # Go to: http://your-pi-ip:1880/ui â†’ Updates tab â†’ Install Update
        
        # Or via command line
        sudo /opt/scripts/update_dashboard.sh
        ```
        
        ## ðŸ“‹ Release Notes
        
        ${{ github.event.inputs.release_notes }}
        
        ## ðŸ”„ Update Methods
        
        1. **Node-RED Dashboard** - Easy web interface at `http://pi-ip:1880/ui`
        2. **API Endpoint** - `curl -X POST http://pi-ip:1880/api/update/now`  
        3. **Update Script** - `sudo /opt/scripts/update_dashboard.sh`
        4. **Quick Update** - `sudo bash -c "$(curl -fsSL https://raw.githubusercontent.com/${{ env.PROD_REPO }}/main/scripts/quick-update.sh)"`
        5. **Manual Start** - `cd ~/cocktail-machine-dev/deployment && ./start-services.sh`
        
        ## ðŸ“¦ Contents
        
        - **`web/`** - Dashboard application (version ${{ steps.version.outputs.version }})
        - **`nodered/`** - Node-RED flows and configuration
        - **`scripts/`** - Installation and update scripts  
        - **`kiosk/`** - Kiosk mode configuration
        - **`web.tar.gz`** - Compressed deployment archive
        
        ---
        
        *ðŸ¤– Automatically deployed from dev repository via GitHub Actions*  
        *â° Last updated: ${{ steps.version.outputs.timestamp }}*
        EOF
        
        echo "âž• Adding all changes to git..."
        git add .
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
            echo "ðŸ”„ Force deployment requested - creating deployment commit"
            git commit --allow-empty -m "ðŸš€ Force deployment: ${{ steps.version.outputs.version }}"
          else
            echo "â„¹ï¸ No changes detected - skipping deployment"
            echo "ðŸ’¡ Use 'force_deploy' option if you want to deploy anyway"
            exit 0
          fi
        else
          echo "ðŸ’¾ Committing production release..."
          git commit -m "ðŸš€ Production Release: ${{ steps.version.outputs.version }}

        ðŸ“¦ Release Details:
        - Version: ${{ steps.version.outputs.version }}
        - Type: ${{ github.event.inputs.release_type }}
        - Timestamp: ${{ steps.version.outputs.timestamp }}
        - Dev Commit: $(cd .. && git rev-parse --short HEAD)
        
        ðŸ“ Release Notes:
        ${{ github.event.inputs.release_notes }}
        
        ðŸ”„ Deployment triggered manually from dev repository
        ðŸŽ¯ Ready for Pi user installations and updates!"
        fi
        
        echo "ðŸš€ Pushing to production repository..."
        git push origin main
        
        echo "âœ… Production deployment completed successfully!"
        
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸŽ‰ Dev â†’ Prod Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ·ï¸ Production Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“¦ Release Type:** ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY  
        echo "**â° Deployed:** ${{ steps.version.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸŽ¯ Production Repo:** [${{ env.PROD_REPO }}](https://github.com/${{ env.PROD_REPO }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Release Notes" >> $GITHUB_STEP_SUMMARY
        echo "${{ github.event.inputs.release_notes }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Pi Users Can Now:" >> $GITHUB_STEP_SUMMARY
        echo "1. **Install Fresh:** \`curl -fsSL https://raw.githubusercontent.com/${{ env.PROD_REPO }}/main/scripts/setup-ultimate.sh | bash\`" >> $GITHUB_STEP_SUMMARY
        echo "2. **Update Existing:** Go to Node-RED Dashboard â†’ Updates Tab â†’ Install Update" >> $GITHUB_STEP_SUMMARY
        echo "3. **Manual Update:** \`sudo /opt/scripts/update_dashboard.sh\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Production deployment is live and ready for users!**" >> $GITHUB_STEP_SUMMARY
